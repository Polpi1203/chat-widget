<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent IA Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <style>
        .chat-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-header {
            background: #3B82F6;
            color: white;
            padding: 1rem;
            font-weight: bold;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            max-width: 80%;
        }

        .user-message {
            background: #DBEAFE;
            color: #1E40AF;
            margin-left: auto;
        }

        .ai-message {
            background: #D1FAE5;
            color: #065F46;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #E5E7EB;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem 0 0 0.375rem;
            outline: none;
        }

        .chat-input button {
            padding: 0.5rem 1rem;
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 0 0.375rem 0.375rem 0;
            cursor: pointer;
        }

        .chat-input button:hover {
            background: #2563EB;
        }

        .chat-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div id="chat-widget"></div>
    <script>
        const ChatWidget = () => {
            const [messages, setMessages] = React.useState([]);
            const [inputValue, setInputValue] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const messagesEndRef = React.useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            React.useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputValue.trim()) return;

                const userMessage = {
                    type: 'user',
                    text: inputValue
                };

                setMessages(prev => [...prev, userMessage]);
                setInputValue('');
                setIsLoading(true);

                try {
                    // Utiliser l'API proxy déployée sur Vercel
                    const response = await fetch('https://chat-widget-neon-eight.vercel.app/api/sendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: userMessage.text })
                    });
                    console.log("test : " + response);
                    if (!response.ok) throw new Error('Erreur réseau');

                    const data = await response.json();

                    setMessages(prev => [...prev, {
                        type: 'ai',
                        text: data.response
                    }]);
                } catch (error) {
                    setMessages(prev => [...prev, {
                        type: 'error',
                        text: "Désolé, une erreur s'est produite."
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return React.createElement('div', { className: 'chat-container' },
                React.createElement('div', { className: 'chat-header' }, 'Agent IA'),
                React.createElement('div', { className: 'chat-messages' },
                    messages.map((msg, idx) =>
                        React.createElement('div', {
                            key: idx,
                            className: `message ${msg.type === 'user' ? 'user-message' : 'ai-message'}`
                        }, msg.text)
                    ),
                    React.createElement('div', { ref: messagesEndRef })
                ),
                React.createElement('form', {
                    className: 'chat-input',
                    onSubmit: handleSubmit
                },
                    React.createElement('input', {
                        type: 'text',
                        value: inputValue,
                        onChange: (e) => setInputValue(e.target.value),
                        placeholder: 'Posez votre question...',
                        disabled: isLoading
                    }),
                    React.createElement('button', {
                        type: 'submit',
                        disabled: isLoading
                    }, isLoading ? 'Envoi...' : 'Envoyer')
                )
            );
        };

        ReactDOM.render(
            React.createElement(ChatWidget),
            document.getElementById('chat-widget')
        );
    </script>

</body>

</html>